# Makefile for STM32F091 Nucleo board
# $(CC) -E -dD -std=c11 -g3 -Os -Wall -mcpu=cortex-m0 -mlittle-endian -mthumb -I$(inc) -I$(CMSIS) -DSTM32F091xC -T$(linker)  -Wl,--gc-sections $(source).c $(startup) $(system) -o $(source).elf
# -E -dD

CC = arm-none-eabi-gcc
GDB = arm-none-eabi-gdb

inc = include
CMSIS = $(inc)/CMSIS/

linker = $(inc)/STM32F091RCTx_FLASH.ld
startup = $(inc)/startup_stm32f091xc.s
system = $(inc)/system_stm32f0xx.c
source = main
utils = $(inc)/utils.c

.PHONY: default compile test con setup_gdb flash

default: compile con
	compile
	con

compile:
	$(CC) -std=c99 -g3 -O0 -Wall -mcpu=cortex-m0 -mlittle-endian -mthumb -I$(inc) -I$(CMSIS) -DSTM32F091xC -T$(linker)  -Wl,--gc-sections src/$(source).c $(startup) $(system) -o dest/$(source).elf
	arm-none-eabi-objcopy -Oihex dest/$(source).elf dest/$(source).hex

con:
	openocd -f /usr/share/openocd/scripts/board/st_nucleo_f0.cfg

setup_gdb:
	$(GDB) -x gdb/debug.gdb

setup_gdb_flash:
	$(GDB) -x scripts/flash.gdb

# todo: establish connections there
debug: setup_gdb
	setup_gdb

flash: setup_gdb_flash
	setup_gdb_flash

