/* This header contains math functions for the kisaburo project
 * author: Pawel Balawender
 * contact: voilagrange@gmail.com
 */
#include"_math.h"

#define VAL_AMOUNT (256U)
#define STEP (VAL_AMOUNT / TAU)

const float sin_values[VAL_AMOUNT] = {
    0.0000000,  0.0061599,  0.0123197,  0.0184789,  0.0246374,  0.0307951,
    0.0369515,  0.0431065,  0.0492599,  0.0554115,  0.0615609,  0.0677080,
    0.0738525,  0.0799943,  0.0861329,  0.0922684,  0.0984003,  0.1045285,
    0.1106527,  0.1167727,  0.1228883,  0.1289992,  0.1351052,  0.1412062,
    0.1473017,  0.1533917,  0.1594758,  0.1655539,  0.1716257,  0.1776910,
    0.1837495,  0.1898011,  0.1958455,  0.2018824,  0.2079117,  0.2139331,
    0.2199464,  0.2259513,  0.2319476,  0.2379352,  0.2439137,  0.2498830,
    0.2558428,  0.2617929,  0.2677330,  0.2736630,  0.2795826,  0.2854916,
    0.2913897,  0.2972769,  0.3031527,  0.3090170,  0.3148696,  0.3207102,
    0.3265387,  0.3323548,  0.3381583,  0.3439489,  0.3497265,  0.3554908,
    0.3612417,  0.3669788,  0.3727020,  0.3784111,  0.3841057,  0.3897859,
    0.3954512,  0.4011015,  0.4067366,  0.4123563,  0.4179603,  0.4235485,
    0.4291206,  0.4346764,  0.4402157,  0.4457384,  0.4512441,  0.4567326,
    0.4622039,  0.4676576,  0.4730936,  0.4785116,  0.4839114,  0.4892929,
    0.4946558,  0.5000000,  0.5053252,  0.5106312,  0.5159178,  0.5211849,
    0.5264322,  0.5316595,  0.5368666,  0.5420534,  0.5472195,  0.5523650,
    0.5574894,  0.5625928,  0.5676747,  0.5727351,  0.5777738,  0.5827906,
    0.5877853,  0.5927576,  0.5977075,  0.6026346,  0.6075389,  0.6124202,
    0.6172782,  0.6221128,  0.6269238,  0.6317110,  0.6364742,  0.6412133,
    0.6459281,  0.6506183,  0.6552839,  0.6599245,  0.6645402,  0.6691306,
    0.6736956,  0.6782351,  0.6827489,  0.6872367,  0.6916984,  0.6961339,
    0.7005430,  0.7049255,  0.7092813,  0.7136102,  0.7179119,  0.7221865,
    0.7264336,  0.7306531,  0.7348450,  0.7390089,  0.7431448,  0.7472525,
    0.7513319,  0.7553827,  0.7594049,  0.7633983,  0.7673627,  0.7712980,
    0.7752040,  0.7790806,  0.7829276,  0.7867449,  0.7905324,  0.7942899,
    0.7980172,  0.8017143,  0.8053809,  0.8090170,  0.8126224,  0.8161969,
    0.8197405,  0.8232529,  0.8267342,  0.8301840,  0.8336024,  0.8369891,
    0.8403441,  0.8436671,  0.8469582,  0.8502171,  0.8534438,  0.8566381,
    0.8597999,  0.8629290,  0.8660254,  0.8690889,  0.8721195,  0.8751170,
    0.8780812,  0.8810122,  0.8839097,  0.8867737,  0.8896040,  0.8924006,
    0.8951633,  0.8978920,  0.9005867,  0.9032472,  0.9058734,  0.9084653,
    0.9110226,  0.9135455,  0.9160336,  0.9184870,  0.9209055,  0.9232891,
    0.9256377,  0.9279511,  0.9302293,  0.9324722,  0.9346798,  0.9368518,
    0.9389884,  0.9410893,  0.9431544,  0.9451838,  0.9471774,  0.9491349,
    0.9510565,  0.9529420,  0.9547913,  0.9566044,  0.9583812,  0.9601216,
    0.9618256,  0.9634931,  0.9651241,  0.9667184,  0.9682760,  0.9697969,
    0.9712810,  0.9727283,  0.9741386,  0.9755120,  0.9768483,  0.9781476,
    0.9794098,  0.9806348,  0.9818226,  0.9829731,  0.9840863,  0.9851622,
    0.9862007,  0.9872018,  0.9881655,  0.9890916,  0.9899802,  0.9908313,
    0.9916447,  0.9924205,  0.9931587,  0.9938591,  0.9945219,  0.9951469,
    0.9957342,  0.9962837,  0.9967953,  0.9972692,  0.9977052,  0.9981033,
    0.9984636,  0.9987860,  0.9990705,  0.9993171,  0.9995257,  0.9996965,
    0.9998293,  0.9999241,  0.9999810,  1.0000000,
};

// values for atan2(y, x), where P = (x, y) belongs to the unit circle O((0, 0), 1)
// since we have a x <-> y relation >>sqrt(x2 + y2)=1<<, we dont need the y parameter
// this enables us to for each x have only one atan2 value
const float atan2_values[VAL_AMOUNT] = {
    1.5707963,  1.5668901,  1.5629837,  1.5590773,  1.5551707,  1.5512638,
    1.5473567,  1.5434492,  1.5395412,  1.5356328,  1.5317239,  1.5278143,
    1.5239041,  1.5199932,  1.5160815,  1.5121690,  1.5082556,  1.5043412,
    1.5004258,  1.4965093,  1.4925916,  1.4886728,  1.4847527,  1.4808313,
    1.4769085,  1.4729842,  1.4690584,  1.4651311,  1.4612021,  1.4572714,
    1.4533389,  1.4494047,  1.4454685,  1.4415304,  1.4375902,  1.4336480,
    1.4297037,  1.4257571,  1.4218082,  1.4178571,  1.4139035,  1.4099474,
    1.4059888,  1.4020275,  1.3980636,  1.3940970,  1.3901276,  1.3861552,
    1.3821799,  1.3782016,  1.3742203,  1.3702357,  1.3662479,  1.3622568,
    1.3582624,  1.3542645,  1.3502631,  1.3462581,  1.3422494,  1.3382370,
    1.3342207,  1.3302006,  1.3261765,  1.3221483,  1.3181161,  1.3140796,
    1.3100388,  1.3059937,  1.3019442,  1.2978901,  1.2938314,  1.2897680,
    1.2856999,  1.2816269,  1.2775489,  1.2734660,  1.2693779,  1.2652846,
    1.2611860,  1.2570821,  1.2529726,  1.2488576,  1.2447370,  1.2406106,
    1.2364783,  1.2323401,  1.2281959,  1.2240456,  1.2198890,  1.2157261,
    1.2115567,  1.2073808,  1.2031983,  1.1990090,  1.1948128,  1.1906097,
    1.1863996,  1.1821822,  1.1779575,  1.1737255,  1.1694859,  1.1652387,
    1.1609837,  1.1567208,  1.1524499,  1.1481709,  1.1438837,  1.1395881,
    1.1352840,  1.1309712,  1.1266497,  1.1223192,  1.1179797,  1.1136311,
    1.1092731,  1.1049056,  1.1005286,  1.0961417,  1.0917450,  1.0873382,
    1.0829212,  1.0784938,  1.0740558,  1.0696072,  1.0651477,  1.0606772,
    1.0561954,  1.0517023,  1.0471976,  1.0426811,  1.0381527,  1.0336122,
    1.0290594,  1.0244941,  1.0199160,  1.0153251,  1.0107210,  1.0061036,
    1.0014727,  0.9968280,  0.9921693,  0.9874964,  0.9828090,  0.9781069,
    0.9733899,  0.9686577,  0.9639101,  0.9591468,  0.9543675,  0.9495719,
    0.9447599,  0.9399310,  0.9350850,  0.9302217,  0.9253407,  0.9204416,
    0.9155242,  0.9105882,  0.9056332,  0.9006588,  0.8956648,  0.8906507,
    0.8856162,  0.8805609,  0.8754844,  0.8703863,  0.8652662,  0.8601237,
    0.8549583,  0.8497696,  0.8445571,  0.8393204,  0.8340589,  0.8287722,
    0.8234598,  0.8181211,  0.8127556,  0.8073626,  0.8019417,  0.7964922,
    0.7910135,  0.7855050,  0.7799659,  0.7743957,  0.7687935,  0.7631588,
    0.7574906,  0.7517883,  0.7460509,  0.7402777,  0.7344679,  0.7286203,
    0.7227342,  0.7168086,  0.7108424,  0.7048346,  0.6987840,  0.6926895,
    0.6865500,  0.6803641,  0.6741305,  0.6678479,  0.6615149,  0.6551300,
    0.6486915,  0.6421979,  0.6356474,  0.6290382,  0.6223685,  0.6156361,
    0.6088391,  0.6019752,  0.5950419,  0.5880369,  0.5809576,  0.5738010,
    0.5665643,  0.5592444,  0.5518378,  0.5443410,  0.5367502,  0.5290613,
    0.5212699,  0.5133713,  0.5053605,  0.4972320,  0.4889799,  0.4805977,
    0.4720786,  0.4634149,  0.4545983,  0.4456197,  0.4364690,  0.4271352,
    0.4176060,  0.4078676,  0.3979045,  0.3876995,  0.3772328,  0.3664820,
    0.3554212,  0.3440205,  0.3322449,  0.3200530,  0.3073951,  0.2942110,
    0.2804264,  0.2659481,  0.2506557,  0.2343898,  0.2169315,  0.1979655,
    0.1770077,  0.1532430,  0.1250815,  0.0884171,  0.0000000,
};

float read_sin(float x) {
    int index = (int)((x / PI) * VAL_AMOUNT);
    return sin_values[index];
}


float sin_(float x) {
    // map to (-2PI, 2PI)
    x = x - TAU * (int)(x / TAU);
    // map to (PI, PI)
    if (x < -PI) x += TAU;
    else if (x > PI) x -= TAU;

    // map to 1st quarter and get sine
    if (0 <= x && x < PI/2) return read_sin(x);
    else if (PI/2 < x && x < PI) return read_sin(PI - x);
    else if (-PI < x && x < -PI/2) return -read_sin(PI + x);
    else if (-PI/2 < x && x < 0) return -read_sin(-x);
    else return (int)(-1);
}


float cos_(float x) {
    return sin_(x + PI/2);
}

float inv_sq(float x) {
    const float threehalfs = 1.5f;
    float half_x = x * 0.5f;
    float y = x;
    // bit-hacking
    long x_long = *(long*) &y;
    // minuend: magic constant
    x_long = 0x5f3759df - (x_long >> 1);
    y = *(float*) &x_long;
    // 1 iteration of the Newtonian method
    y *= threehalfs - (half_x * y*y);
    return y;
}

float atan2_(float y, float x) {
    // calculate hyp. and map x
    float sq_sum = x*x + y*y;
    x *= inv_sq(sq_sum);
    // get appropriate index in the table
    int x_index = (int)(x * (VAL_AMOUNT - 1));
    // pos. angle for pos. y, negative otherwise
    float val;
    if (x < 0) val = PI - atan2_values[-x_index];
    else val = atan2_values[x_index];
    if (y < 0) val = -val;
    return val;
}
